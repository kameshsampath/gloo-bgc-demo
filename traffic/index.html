
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://kameshsampath.github.com/gloo-bgc-demo/traffic/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.3.0">
    
    
      
        <title>Traffic Management - Gloo Blue Green Canary Demo</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.8b42a75e.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Red+Hat+Display:300,400,400i,700%7C&display=fallback">
        <style>:root{--md-text-font-family:"Red Hat Display";--md-code-font-family:""}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ensure-environment" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Gloo Blue Green Canary Demo" class="md-header__button md-logo" aria-label="Gloo Blue Green Canary Demo" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Gloo Blue Green Canary Demo
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Traffic Management
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Gloo Blue Green Canary Demo" class="md-nav__button md-logo" aria-label="Gloo Blue Green Canary Demo" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Gloo Blue Green Canary Demo
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../tools-and-sources/" class="md-nav__link">
        Tools and Sources
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../env-setup/" class="md-nav__link">
        Environment Setup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../site-to-site-vpn/" class="md-nav__link">
        Site to Site VPN
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../mesh/" class="md-nav__link">
        Setup Gloo Mesh
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Deploy Microservices
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Deploy Microservices" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Deploy Microservices
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deploy-blue/" class="md-nav__link">
        Deploy Blue
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deploy-green/" class="md-nav__link">
        Deploy Green
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../deploy-canary/" class="md-nav__link">
        Deploy Canary
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Traffic Management
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Traffic Management
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ensure-environment" class="md-nav__link">
    Ensure Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#delete-existing-test-gateway" class="md-nav__link">
    Delete Existing Test Gateway
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gloo-mesh-gateway" class="md-nav__link">
    Gloo Mesh Gateway
  </a>
  
    <nav class="md-nav" aria-label="Gloo Mesh Gateway">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-virtual-gateway" class="md-nav__link">
    Deploy Virtual Gateway
  </a>
  
    <nav class="md-nav" aria-label="Deploy Virtual Gateway">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster1" class="md-nav__link">
    CLUSTER1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster2" class="md-nav__link">
    CLUSTER2
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#calling-service" class="md-nav__link">
    Calling Service
  </a>
  
    <nav class="md-nav" aria-label="Calling Service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster1_1" class="md-nav__link">
    Cluster1
  </a>
  
    <nav class="md-nav" aria-label="Cluster1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#call-service" class="md-nav__link">
    Call Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poll-service" class="md-nav__link">
    Poll Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-browser" class="md-nav__link">
    Use Browser
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster2_1" class="md-nav__link">
    Cluster2
  </a>
  
    <nav class="md-nav" aria-label="Cluster2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#call-service_1" class="md-nav__link">
    Call Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poll-service_1" class="md-nav__link">
    Poll Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-browser_1" class="md-nav__link">
    Use Browser
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#traffic-policy" class="md-nav__link">
    Traffic Policy
  </a>
  
    <nav class="md-nav" aria-label="Traffic Policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#green" class="md-nav__link">
    Green
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canary" class="md-nav__link">
    Canary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blue-green" class="md-nav__link">
    Blue &lt;-- --&gt; Green
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bluegreen-and-canary" class="md-nav__link">
    Blue,Green and Canary
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../access-policies/" class="md-nav__link">
        Access Policies
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../clean-up/" class="md-nav__link">
        Clean Up
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          Appendix
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Appendix" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Appendix
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ansible-roles/" class="md-nav__link">
        Ansible Roles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ensure-environment" class="md-nav__link">
    Ensure Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#delete-existing-test-gateway" class="md-nav__link">
    Delete Existing Test Gateway
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gloo-mesh-gateway" class="md-nav__link">
    Gloo Mesh Gateway
  </a>
  
    <nav class="md-nav" aria-label="Gloo Mesh Gateway">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deploy-virtual-gateway" class="md-nav__link">
    Deploy Virtual Gateway
  </a>
  
    <nav class="md-nav" aria-label="Deploy Virtual Gateway">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster1" class="md-nav__link">
    CLUSTER1
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster2" class="md-nav__link">
    CLUSTER2
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#calling-service" class="md-nav__link">
    Calling Service
  </a>
  
    <nav class="md-nav" aria-label="Calling Service">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cluster1_1" class="md-nav__link">
    Cluster1
  </a>
  
    <nav class="md-nav" aria-label="Cluster1">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#call-service" class="md-nav__link">
    Call Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poll-service" class="md-nav__link">
    Poll Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-browser" class="md-nav__link">
    Use Browser
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cluster2_1" class="md-nav__link">
    Cluster2
  </a>
  
    <nav class="md-nav" aria-label="Cluster2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#call-service_1" class="md-nav__link">
    Call Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#poll-service_1" class="md-nav__link">
    Poll Service
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-browser_1" class="md-nav__link">
    Use Browser
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#traffic-policy" class="md-nav__link">
    Traffic Policy
  </a>
  
    <nav class="md-nav" aria-label="Traffic Policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#green" class="md-nav__link">
    Green
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canary" class="md-nav__link">
    Canary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#blue-green" class="md-nav__link">
    Blue &lt;-- --&gt; Green
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bluegreen-and-canary" class="md-nav__link">
    Blue,Green and Canary
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Traffic Management</h1>
                
                <p>At the end of this chapter you would have,</p>
<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Applied Access Policies</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Create TrafficPolicy to distribute traffic</li>
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled checked/><span class="task-list-indicator"></span></label> Integrated VM Workload with Mesh</li>
</ul>
<h2 id="ensure-environment">Ensure Environment<a class="headerlink" href="#ensure-environment" title="Permanent link">&para;</a></h2>
<p>Navigate to Tutorial home</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> <span class="nv">$TUTORIAL_HOME</span>
</code></pre></div>
<p>Set cluster environment variables</p>
<div class="highlight"><pre><span></span><code><span class="nb">source</span> <span class="nv">$TUTORIAL_HOME</span>/.envrc
</code></pre></div>
<h2 id="delete-existing-test-gateway">Delete Existing Test Gateway<a class="headerlink" href="#delete-existing-test-gateway" title="Permanent link">&para;</a></h2>
<p>As we will be configuring the services to use the Gloo Mesh <code>VirtualGateway</code> we will delete the existing Istio test gateways from both the workload clusterst,</p>
<div class="highlight"><pre><span></span><code>kubectl --context<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER1</span><span class="si">}</span><span class="s2">&quot;</span> delete <span class="se">\</span>
  -n blue-green-canary <span class="se">\</span>
  -k <span class="s2">&quot;</span><span class="nv">$TUTORIAL_HOME</span><span class="s2">/demo-app/config/istio&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>kubectl --context<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER2</span><span class="si">}</span><span class="s2">&quot;</span> delete <span class="se">\</span>
  -n blue-green-canary <span class="se">\</span>
  -k <span class="s2">&quot;</span><span class="nv">$TUTORIAL_HOME</span><span class="s2">/demo-app/config/istio&quot;</span>
</code></pre></div>
<p>Let us query the VirtualService(<code>vs</code>) and Gateways(<code>gw</code>) from the workload clusters and check our stocks,</p>
<div class="highlight"><pre><span></span><code>kubectl --context<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER1</span><span class="si">}</span><span class="s2">&quot;</span> get vs,gw -n istio-system
</code></pre></div>
<div class="highlight"><pre><span></span><code>NAME                                           GATEWAYS             HOSTS                                       AGE
virtualservice.networking.istio.io/istiod-vs   [&quot;istiod-gateway&quot;]   [&quot;istiod.istio-system.svc.cluster.local&quot;]   35h

NAME                                                                               AGE
gateway.networking.istio.io/cross-network-gateway                                  35h
gateway.networking.istio.io/istio-ingressgateway-istio-system-cluster1-gloo-mesh   14h
gateway.networking.istio.io/istiod-gateway                                         35h
</code></pre></div>
<div class="highlight"><pre><span></span><code>kubectl --context<span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER2</span><span class="si">}</span><span class="s2">&quot;</span> get vs,gw -n istio-system
</code></pre></div>
<div class="highlight"><pre><span></span><code>NAME                                           GATEWAYS             HOSTS                                       AGE
virtualservice.networking.istio.io/istiod-vs   [&quot;istiod-gateway&quot;]   [&quot;istiod.istio-system.svc.cluster.local&quot;]   35h

NAME                                                                               AGE
gateway.networking.istio.io/cross-network-gateway                                  35h
gateway.networking.istio.io/istio-ingressgateway-istio-system-cluster2-gloo-mesh   14h
gateway.networking.istio.io/istiod-gateway                                         35h
</code></pre></div>
<h2 id="gloo-mesh-gateway">Gloo Mesh Gateway<a class="headerlink" href="#gloo-mesh-gateway" title="Permanent link">&para;</a></h2>
<p>Let us now create <code>VirtualGateway</code>, <code>VirtualHost</code> and  <code>RouteTable</code> to route to enable traffic routing to the <code>blue-green-canary</code> service across the <code>VirtualMesh</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>VirtualMesh</code> includes the on-premise VM</p>
</div>
<h3 id="deploy-virtual-gateway">Deploy Virtual Gateway<a class="headerlink" href="#deploy-virtual-gateway" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="nv">$TUTORIAL_HOME</span>/bin/7_deploy_gateway.sh
</code></pre></div>
<p>Let us verify if <code>Gateway</code> and <code>VirtualService</code> are created on both the workload clusters,</p>
<h4 id="cluster1">CLUSTER1<a class="headerlink" href="#cluster1" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>kubectl --context<span class="o">=</span><span class="si">${</span><span class="nv">CLUSTER1</span><span class="si">}</span> get gw,vs -A 
</code></pre></div>
<div class="highlight"><pre><span></span><code>NAMESPACE      NAME                                                                               AGE
<mark class="critic">istio-system   gateway.networking.istio.io/bgc-virtualgateway-17072781039916753854 </mark>               5s
istio-system   gateway.networking.istio.io/cross-network-gateway                                  35h
istio-system   gateway.networking.istio.io/istio-ingressgateway-istio-system-cluster1-gloo-mesh   14h
istio-system   gateway.networking.istio.io/istiod-gateway                                         35h

NAMESPACE      NAME                                                           GATEWAYS                                                   HOSTS                                       AGE
<mark class="critic">gloo-mesh      virtualservice.networking.istio.io/bgc-virtualhost-gloo-mesh   [&quot;istio-system/bgc-virtualgateway-17072781039916753854&quot;]   [&quot;*&quot;]</mark>                                       5s
istio-system   virtualservice.networking.istio.io/istiod-vs                   [&quot;istiod-gateway&quot;]                                         [&quot;istiod.istio-system.svc.cluster.local&quot;]   35h
</code></pre></div>
<h4 id="cluster2">CLUSTER2<a class="headerlink" href="#cluster2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>kubectl --context<span class="o">=</span><span class="si">${</span><span class="nv">CLUSTER2</span><span class="si">}</span> get gw,vs -A 
</code></pre></div>
<div class="highlight"><pre><span></span><code>NAMESPACE      NAME                                                                               AGE
<mark class="critic">istio-system   gateway.networking.istio.io/bgc-virtualgateway-9692221184781295762   </mark>              47s
istio-system   gateway.networking.istio.io/cross-network-gateway                                  35h
istio-system   gateway.networking.istio.io/istio-ingressgateway-istio-system-cluster2-gloo-mesh   14h
istio-system   gateway.networking.istio.io/istiod-gateway                                         35h

NAMESPACE      NAME                                                           GATEWAYS                                                  HOSTS                                       AGE
<mark class="critic">gloo-mesh      virtualservice.networking.istio.io/bgc-virtualhost-gloo-mesh   [&quot;istio-system/bgc-virtualgateway-9692221184781295762&quot;]   [&quot;*&quot;]</mark>                                       47s
istio-system   virtualservice.networking.istio.io/istiod-vs                   [&quot;istiod-gateway&quot;]                                        [&quot;istiod.istio-system.svc.cluster.local&quot;]   35h
</code></pre></div>
<h2 id="calling-service">Calling Service<a class="headerlink" href="#calling-service" title="Permanent link">&para;</a></h2>
<h3 id="cluster1_1">Cluster1<a class="headerlink" href="#cluster1_1" title="Permanent link">&para;</a></h3>
<p>Retrive the Istio Ingress Gateway url to access the application,</p>
<div class="highlight"><pre><span></span><code><span class="nv">SVC_GW_CLUSTER1</span><span class="o">=</span><span class="k">$(</span>kubectl --context <span class="si">${</span><span class="nv">CLUSTER1</span><span class="si">}</span> -n istio-system get svc istio-ingressgateway -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.loadBalancer.ingress[0].*}&#39;</span><span class="k">)</span>
</code></pre></div>
<h4 id="call-service">Call Service<a class="headerlink" href="#call-service" title="Permanent link">&para;</a></h4>
<p>Call the service using the script,</p>
<div class="highlight"><pre><span></span><code><span class="nv">$TUTORIAL_HOME</span>/bin/call_bgc_service.sh <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER1</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<h4 id="poll-service">Poll Service<a class="headerlink" href="#poll-service" title="Permanent link">&para;</a></h4>
<p>Poll the service using the script,</p>
<div class="highlight"><pre><span></span><code><span class="nv">$TUTORIAL_HOME</span>/bin/poll_bgc_service.sh <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER1</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<h4 id="use-browser">Use Browser<a class="headerlink" href="#use-browser" title="Permanent link">&para;</a></h4>
<p>Open the URL in the browser <code>open http://$SVC_GW_CLUSTER1</code>.</p>
<h3 id="cluster2_1">Cluster2<a class="headerlink" href="#cluster2_1" title="Permanent link">&para;</a></h3>
<p>Retrive the Istio Ingress Gateway url to access the application,</p>
<div class="highlight"><pre><span></span><code><span class="nv">SVC_GW_CLUSTER2</span><span class="o">=</span><span class="k">$(</span>kubectl --context <span class="si">${</span><span class="nv">CLUSTER2</span><span class="si">}</span> -n istio-system get svc istio-ingressgateway -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.loadBalancer.ingress[0].*}&#39;</span><span class="k">)</span>
</code></pre></div>
<h4 id="call-service_1">Call Service<a class="headerlink" href="#call-service_1" title="Permanent link">&para;</a></h4>
<p>Call the service using the script,</p>
<div class="highlight"><pre><span></span><code><span class="nv">$TUTORIAL_HOME</span>/bin/call_bgc_service.sh <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER2</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<h4 id="poll-service_1">Poll Service<a class="headerlink" href="#poll-service_1" title="Permanent link">&para;</a></h4>
<p>Poll the service using the script,</p>
<div class="highlight"><pre><span></span><code><span class="nv">$TUTORIAL_HOME</span>/bin/poll_bgc_service.sh <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER2</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<h4 id="use-browser_1">Use Browser<a class="headerlink" href="#use-browser_1" title="Permanent link">&para;</a></h4>
<p>Open the URL in the browser <code>open http://$SVC_GW_CLUSTER2</code>.</p>
<p>As you have observed the <code>blue-green-canary</code> service is by default configured to return the response from version <code>blue</code>.</p>
<h2 id="traffic-policy">Traffic Policy<a class="headerlink" href="#traffic-policy" title="Permanent link">&para;</a></h2>
<p>As we have unified the mesh we are good to distribute traffic amongst them. As part of the next section we will apply various traffic policies to distribute traffic amongst the <code>blue</code>, <code>green</code> and <code>canary</code> services.</p>
<p>Before we try the traffic shifting, open the service in the browser,</p>
<div class="highlight"><pre><span></span><code><span class="nv">$TUTORIAL_HOME</span>/bin/browse_bgc_service.sh <span class="s2">&quot;</span><span class="si">${</span><span class="nv">CLUSTER1</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>
<p><img align="center" alt="All Blue" src="../images/all_blue.png" /></p>
<h3 id="green">Green<a class="headerlink" href="#green" title="Permanent link">&para;</a></h3>
<p>As we already have traffic sent to <em>blue</em>, let use try sending all the traffic to <em>green</em></p>
<div class="highlight"><pre><span></span><code><span class="nv">$TUTORIAL_HOME</span>/bin/8_green.sh
</code></pre></div>
<p>Now if you try to call the service via browser or cli as <a href="./#calling-service">described</a> it should return response from <em>green</em> service.</p>
<p><img align="center" alt="All Blue" src="../images/all_green.png" /></p>
<h3 id="canary">Canary<a class="headerlink" href="#canary" title="Permanent link">&para;</a></h3>
<p>Let us now try sending all the traffic to <em>canary</em> service on the VM,</p>
<div class="highlight"><pre><span></span><code><span class="nv">$TUTORIAL_HOME</span>/bin/9_canary.sh
</code></pre></div>
<p>Now if you try to call the service via browser or cli as <a href="./#calling-service">described</a> it should return response from <em>canary</em> service that is deployed in on-premise VM.</p>
<p><img align="center" alt="All Blue" src="../images/all_canary.png" /></p>
<h3 id="blue-green">Blue &larr; &rarr; Green<a class="headerlink" href="#blue-green" title="Permanent link">&para;</a></h3>
<p>Let&rsquo;s try to split the traffic between <em>blue</em>(<code>50%</code>) and <em>green</em>(<code>50%</code>),</p>
<div class="highlight"><pre><span></span><code><span class="nv">$TUTORIAL_HOME</span>/bin/11_blue-green.sh
</code></pre></div>
<p>If you try check your browser you should see an alternating blue-green traffic.</p>
<h2 id="bluegreen-and-canary">Blue,Green and Canary<a class="headerlink" href="#bluegreen-and-canary" title="Permanent link">&para;</a></h2>
<p>Finally let&rsquo;s try to split the traffic between <em>blue</em>(<code>40%</code>),<em>green</em>(<code>40%</code>) and <em>canary</em>(<code>20%</code>),</p>
<div class="highlight"><pre><span></span><code><span class="nv">$TUTORIAL_HOME</span>/bin/12_blue-green-canary.sh
</code></pre></div>
<p>If you try check your browser you should see almost equal traffic to <em>blue</em> and <em>green</em> and few requests to <em>canary</em>.</p>
<p>Now we checked the traffic distribution amongst revsions that are deployed on Istio clusters and VM. In the next chapter lets us apply access policies to restrict who and from where we can acess the service.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../deploy-canary/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Deploy Canary" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Deploy Canary
            </div>
          </div>
        </a>
      
      
        
        <a href="../access-policies/" class="md-footer__link md-footer__link--next" aria-label="Next: Access Policies" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Access Policies
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "content.tabs.link"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.f8263e09.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4fc53ad4.min.js"></script>
      
    
  </body>
</html>